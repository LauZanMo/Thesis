# 基于双目视觉的无人自主飞行器的设计与实现

# 1 绪论

## 1.1 研究背景

​		四旋翼飞行器，是一种可以垂直起降，自由悬停的飞行器，因其拥有四个呈十字形交叉的螺旋桨的紧凑结构而得名，其相对于固定翼飞机有着起飞场地更加自由且能够悬停的优势，因此，四旋翼飞行器能够在军用或民用领域完成复杂的室内场景任务。

​		如今的飞行器，应用领域相当广泛，主要应用领域如下：

1. 商业：飞行器应用最广的领域是商业领域，常被用于商业宣传、新闻采集、航拍摄影、物流运输、飞行器表演等多种用途。
2. 农业：飞行器在农业领域的应用也越来越多，小型农业飞行器用于进行农情检测与环境气候探测，大型农业飞行器则用于进行辅助授粉与农药喷洒。
3. 能源业：飞行器在能源业通常被用于进行电力巡检、石油管道巡检、天然气管道巡检以及电梯井测量。
4. 救援：飞行器在救援领域一直倍受重视，通常用于进行防汛抗旱，灾害救援，运送医疗物品以及紧急远程诊断。

​		室外飞行器定位主要依赖GPS，GPS的搜星数量是飞行器定位的重要指标，但是，针对无GPS的室内环境下，飞行器则需要使用其他传感器进行定位与导航，同时，室内飞行器的体积与功耗也对算法的复杂程度有所限制，因此，如何在有限的体积与功耗的情况下，使用合适的传感器，提升飞行器的室内定位精度与鲁棒性，是飞行器室内定位的关键。

## 1.2 研究现状

​		国内外关于飞行器室内定位导航方案较多，以下列出几种应用于室内的解决方案：

​		超宽带定位导航。又称为UWB，其使用纳秒级非正弦波窄脉冲传输数据，有很高的时间分辨率，因此被运用到室内定位中，目前大部分室内定位产品运用的是Decawave推出的DW1000芯片，有集成度高，价格低廉的优点，但是，UWB也有信号容易被阻隔，需要提前布置的缺点，在地质勘探等高危场景下并不适用。

​		雷达定位导航。目前主流雷达定位方法主要是激光雷达和毫米波雷达，雷达测量精度高，在较暗环境下相较于视觉表现更好，在自动驾驶领域采用雷达方案的较多。但是，用于三维定位的雷达价格极高，且扫描频率低，不适合高速运动情况下的飞行器进行定位与导航，对于体积和拉力更小的室内无人机，如何承载三维雷达的重量也是室内无人机导航定位的一大难题。

​		视觉定位导航。目前主流视觉SLAM前端方法有特征点法，光流法，直接法，后端方法有滤波器法和图优化法，相较于其他两种方法，特征点法有精度高的优点，但是需要对整张图像进行特征点提取，对算力要求更大，其他两种方法精度稍低，但是胜在速度更快，更适合算力较低的计算平台。图优化法相较于滤波器法精度更高，但是对于地图较大的场景维护速度会下降，滤波器法因为只需要考虑最近的数据，所以速度更快，但是会存在累积误差。

​		视觉定位导航相对于其他定位方法的最主要的优点是传感器价格低廉、重量轻便和获取的信息丰富，完美满足了室内飞行器对于定位传感器的要求。因此，视觉定位也是当前的研究热门之一，以下列出主流的视觉定位算法介绍：

​		ORB-SLAM。ORB-SLAM前端采用了特征点法，提取ORB算子并进行图像之间的匹配，对匹配结果进行随机采样一致性(RANSAC)算法之后构建图优化的框架，对相机位姿与地图点进行光束法平差(BA)，构建局部地图，后端则采用了DBoW2词袋进行回环检测，检测到回环后进行全局光束法平差(BA)，优化全局地图。最近开源的ORB-SLAM3则是引入了Kannala-Brandt的相机模型用于适配鱼眼相机，加入惯导进行视觉-惯导紧组合提升定位精度，以及提出Atlas进行地图管理，在跟踪丢失后尝试建立新地图，并在检测到地图内联时进行多地图融合，增强了鲁棒性。

​		VINS。VINS前端采用了KLT光流法，通过计算图像部分像素运动来跟踪特征点位置，IMU则进行预积分处理，未初始化前，进行视觉惯导对齐与视觉sfm，初始化后，将IMU对相机位姿的预测和对特征点的三角化测量放入滑动窗口中并进行滑动窗口图优化，后端则是将基于视觉构造的残差项和基于IMU构造的残差项放在一起构造成一个联合优化的问题，通过非线性优化，进行地图点与位姿进行全局优化。

​		DSO。DSO并不是一个完整的SLAM系统，没有后端中的回环检测和重定位。DSO前端采用了直接法，执行初始化后，对刚出现的地图点标记为未成熟点，伴随着运动，DSO沿极线搜索后对未成熟点进行最小化光度误差，计算出地图点，对于非关键帧，DSO仅计算相机的位姿，对于关键帧，除了计算相机位姿之外，DSO还会将关键帧加入后端优化，后端会执行残差项的增添与删减、新未成熟点的提取的操作，最后通过非线性优化，对地图点与位姿进行全局优化。

​		如今行业内的解决方法如下：

​		![image-20210420203332221](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210420203332221.png)

![image-20210420203437735](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210420203437735.png)		

​		图1.1和图1.2分别为DJI的经纬M300 RTK飞行器和御Mavic 2飞行器，其中两种飞行器都采用的室内无GPS定位方案为双目视觉定位，其中御Mavic 2飞行器采用了四路双目视觉进行定位，而经纬M300 RTK飞行器则在采用了六路双目视觉的基础上，还采用了六路tof传感器和毫米波雷达进行定位。

![image-20210420205210598](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210420205210598.png)

​		图1.3为阿木实验室基于PX4开源飞行器设计的Prometheus450飞行器，采用的室内定位方法是使用英特尔开发的T265双目鱼眼相机内置的定位算法，直接输出里程计数据，与2D光流模块、激光雷达进行的cartographer的2D激光SLAM输出的定位数据进行松组合，输出最终的定位数据进行飞行器室内定位与控制。

​		本文旨在运用机载相机，对机载相机参数、硬件及定位导航策略进行优化，提升飞行器在无GPS情况下室内定位的精度与鲁棒性，从而运用到地质勘探，廊道巡逻等无GPS的复杂环境下。

## 1.3 主要内容与章节安排

​		本文主要的研究内容是设计一套基于双目视觉的无人自主飞行器，其中包括飞行器硬件系统的设计，鱼眼相机T265标定，飞行器软件系统的设计。飞行器硬件系统的设计包括传感器数据采集和飞行器硬件结构设计；鱼眼相机T265标定包括鱼眼相机投影模型与畸变模型的选用、鱼眼相机的标定；无人机软件系统的设计包括双目视觉定位算法的实现、飞行器闭环控制、飞行器通信和飞行器软件框架的搭建。

​		本文第一章介绍了室内飞行器定位的研究背景和研究现状；第二章分析了四旋翼飞行器设计的基础理论与鱼眼相机误差模型和标定方法；第三章讲述了飞行器传感器数据采集和飞行器硬件结构设计；第四章介绍了双目视觉定位算法的实现、飞行器闭环控制、飞行器通信、飞行器软件系统框架；第五章讲述了对基于双目视觉的无人自主飞行器的性能进行测试与分析，第六章则是对基于双目视觉的无人自主飞行器进行总结，并提出对该系统的改进思路以及对未来的展望。

# 2 四旋翼飞行器设计基础与鱼眼相机误差模型和标定方法

​		本章将讲述四旋翼动力系统建模、四旋翼控制建模、与鱼眼相机误差模型及其标定方法。

## 2.1 四旋翼飞行器动力系统建模

​		飞行器的动力系统建模总共分为四部分，为螺旋桨建模，电机建模，电调建模和电池建模。建模参数由多旋翼生产厂商提供参数或自设计专业测试设备测量所得参数输入。

​		对于各个模型，都有具体的参数指标。螺旋桨参数$\Theta_p$包括螺旋桨直径$D_p$、螺旋桨螺距$H_p$、螺旋桨桨叶数$B_p$、螺旋桨叶片平均气动弦长$c_p$和螺旋桨重量$G_p$；电机参数$\Theta_m$包括电机标称空载电流$I_{m0}$、电机标称空载电压$U_{m0}$、电机标称空载$KV$值$K_{V0}$、电机最大电流$I_{mMax}$、内阻$R_m$和重量$G_m$；电调参数$\Theta_e$包括电调最大电流$I_{eMax}$、电调内阻$R_e$和电调重量$G_e$；电池参数$\Theta_b$包括电池总容量$C_b$、电池内阻$R_b$、电池总电压${U_b}$、电池最大放电倍率$K_b$和电池重量$G_b$。

​		评估飞行器的最基础的参数是悬停时间，对于飞行器的悬停时间评估的流程框图如图2.1所示：

![image-20210420215915830](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210420215915830.png)

​		其中单轴需要提供的拉力由飞行器总重以及飞行器旋翼个数参数计算可得，对于四旋翼飞行器，旋翼个数为4；由单轴需要提供的拉力以及飞行器飞行所处海拔、温度、螺旋桨参数输入拉力逆模型可得单轴的转速；由单轴转速以及飞行器所处海拔、温度、螺旋桨参数输入转矩模型可得单轴的转矩；由单轴转速、单轴转矩以及电机参数输入电机模型可得单轴所需要提供的等效电压和等效电流；由单轴等效电压和等效电流以及电调参数、电池参数输入电调模型可得单轴电调油门指令和单轴电调输入电流和电压；由单轴电调输入电流和电压以及旋翼个数、电池参数输入电池模型可得电池放电时间，也就是悬停时间。

### 2.1.1 螺旋桨模型

​		螺旋桨模型由拉力模型、拉力逆模型和转矩模型组成，其中拉力模型与拉力逆模型互为逆运算，由拉力逆模型和相关参数可以计算出单轴的转速，由转矩模型和相关参数可以计算出单轴的转矩。

#### 2.1.1.1 拉力模型

​		螺旋桨的拉力可以由下式计算而得：
$$
T=C_{\mathrm{T}} \rho\left(\frac{N}{6 0}\right)^{2} D_{\mathrm{p}}^{4}
$$
​		其中$T$为单轴螺旋桨的拉力，$C_{\mathrm{T}}$为螺旋桨拉力系数，$\rho$为空气密度，$N$为螺旋桨转速，$D_{\mathrm{p}}$为螺旋桨直径。空气密度可由下式联立而得：
$$
\rho=\frac{273 P_{\mathrm{a}}}{101325\left(273+T_{\mathrm{t}}\right)} {\rho_{0}}
$$

$$
P_{\mathrm{a}}=101325\left(1-0.0065 \frac{h}{273+\mathrm{T}_t}\right)^{5.2561}
$$

$$
\rho_0=1.293kg/m^3
$$

​		其中$T_{\mathrm{t}}$为飞行器所处位置的温度，$h$为飞行器所处位置的海拔。

#### 2.1.1.2 拉力逆模型

​		拉力逆模型与拉力模型互为逆运算，可由单轴所需提供的拉力计算出螺旋桨的转速，将下式联立：
$$
N=60 \sqrt{\frac{T}{D_{\mathrm{p}}^{4} C_{\mathrm{T}} \rho}}
$$

$$
T=\frac{G}{n_r}
$$

​		$N$，$T$，$D_{\mathrm{p}}$，$C_{\mathrm{T}}$，$\rho$已在拉力模型中解释，$G$为飞行器的重量，$n_r$为螺旋桨个数，联立可得
$$
N=60 \sqrt{\frac{G}{{n_r}D_{\mathrm{p}}^{4} C_{\mathrm{T}} \rho}}
$$
​		由拉力逆模型和相关参数输入可得单轴螺旋桨所需提供的转速。

#### 2.1.1.3 转矩模型

​		螺旋桨的转矩可由下式联立：
$$
M=C_{\mathrm{M}} \rho\left(\frac{N}{60}\right)^{2} D_{\mathrm{p}}^{5}
$$

$$
N=60 \sqrt{\frac{G}{n_{\mathrm{r}} D_{\mathrm{p}}^{4} C_{\mathrm{T}} \rho}}
$$

​		除去拉力模型与拉力逆模型所述，$M$为转矩，$C_{\mathrm{M}}$为螺旋桨转矩系数，联立可得：
$$
M={C_\mathrm{M}}\frac{G}{n_\mathrm{r}C_\mathrm{T}}D_\mathrm{p}
$$
​		由转矩模型和相关参数输入可得单轴螺旋桨所需提供的转矩。

### 2.1.2 电机模型

​		电机模型中的电磁转矩可由下式得：
$$
T_\mathrm{e}=K_\mathrm{T}I_\mathrm{m}
$$
​		其中$T_\mathrm{e}$为电磁转矩，$K_\mathrm{T}$为电机转矩常数，$I_\mathrm{m}$为电枢电流。电机转矩常数可由下式联立而得：
$$
K_\mathrm{T}=\frac{60}{2\pi}K_\mathrm{E}
$$

$$
K_\mathrm{E}=\frac{U_{\mathrm{m}0}-I_{\mathrm{m}0}R_\mathrm{m}}{K_{\mathrm{V}0}U_{\mathrm{m}0}}
$$

​		$U_{\mathrm{m}0}$，$I_{\mathrm{m}0}$，$R_\mathrm{m}$，$K_{\mathrm{V}0}$为器件参数，可由电机生产厂商提供的标称值获得。

​		若忽略开关变化的过渡过程和电枢绕组的电感，则无刷电机的等效电路如图2.2所示：

![image-20210421112807720](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210421112807720.png)

​		由电磁转矩公式和等效电路可得输出转矩、等效电流和等效电压：
$$
M=K_\mathrm{T}(I_\mathrm{m}-I_\mathrm{m0})
$$

$$
I_\mathrm{m}=\frac{M}{K_\mathrm{T}}+I_\mathrm{m0}
$$

$$
U_\mathrm{m}=K_\mathrm{E}N+R_\mathrm{m}I_\mathrm{m}
$$

​		其中$M$为拉力逆模型输出的转矩，$I_\mathrm{m}$为等效电流，$U_\mathrm{m}$等效电压。

### 2.1.3 电调模型

​		电调模型的等效电路如图2.3所示：

![image-20210421115344644](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210421115344644.png)

​		由等效电路可得：
$$
U_\mathrm{eo}=U_\mathrm{m}+I_\mathrm{m}R_\mathrm{e}
$$

$$
\sigma=\frac{U_\mathrm{eo}}{U_\mathrm{e}}\approx\frac{U_\mathrm{eo}}{U_\mathrm{b}}
$$

$$
I_\mathrm{e}=\sigma I_\mathrm{m}
$$

$$
U_\mathrm{e}=U_\mathrm{b}-n_\mathrm{r}I_\mathrm{e}R_\mathrm{b}
$$

​		其中$U_\mathrm{eo}$为经过电调调制后的直流电压，$\sigma$为控制器输入的电调油门指令，$U_\mathrm{b}$为电池电压，$I_\mathrm{e}$为电调输入电流，$U_\mathrm{e}$为电调输入电压，也就是电池输出电压，$n_\mathrm{r}$为电调个数，也就是飞行器轴的个数，对于四旋翼则为4，$R_\mathrm{b}$电池内阻。

### 2.1.4 电池模型

​		实际的飞行器锂电池会随着放电时间延长而降低电压，悬停电流则会变大，为了简化电池模型，假设电池在放电过程中电压、电流不变，且放电能力呈线性变化，则有：
$$
I_{\mathrm{b}}=n_{\mathrm{r}} I_{\mathrm{e}}+I_{\text {other }}
$$

$$
C_{\text {real }}=C_{\mathrm{b}}-I_{\mathrm{b}} T_{\text {real }}
$$

$$
T_{\mathrm{b}}=\frac{C_{\mathrm{b}}-C_{\mathrm{min}}}{I_{\mathrm{b}}}\cdot\frac{60}{1000}
$$

​		其中$I_{\mathrm{b}}$为电池电流，$I_{\text {other }}$为除飞行器动力以外其他设备的电流消耗，$C_{\text {real }}$为电池实际剩余电容量，$T_{\text {real }}$为电池实际使用时间，$T_{\mathrm{b}}$为电池放电时间，$C_{\mathrm{min}}$电池最小放电容量。

## 2.2 四旋翼控制建模

​		多旋翼控制模型的流程框图如图2.4所示：

![image-20210421204332610](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210421204332610.png)

​		四旋翼控制模型由四旋翼飞行控制刚体模型、控制效率模型和动力单元模型构成，其中四旋翼飞行控制刚体模型由四旋翼刚体运动学模型和四旋翼刚体动力学模型构成。油门指令输入动力单元模型，可以输出螺旋桨转速；螺旋桨转速输入控制效率模型，可以输出拉力和力矩；拉力和力矩输入刚体动力学模型，可以输出速度和角速度；速度和角速度输入刚体运动学模型，可以输出位置和姿态。

### 2.2.1 四旋翼飞行控制刚体模型

​		四旋翼飞行控制刚体模型由四旋翼刚体运动学模型和四旋翼刚体动力学模型构成。其中四旋翼刚体运动学模型有三种表达形式：基于欧拉角的刚体运动学模型、基于旋转矩阵的刚体运动学模型和基于四元数的刚体运动学模型。三种模型都描述了刚体在六个自由度上位置与姿态的变化关系。四旋翼刚体动力学模型则由位置动力学模型和姿态动力学模型构成。

#### 2.2.1.1 基于欧拉角的刚体运动学模型

​		基于欧拉角的刚体运动学模型可由下式联立表示：
$$
{ }^{\mathrm{e}} \dot{\mathbf{p}}={ }^{\mathrm{e}} \mathbf{v}
$$

$$
\dot{\boldsymbol{\Theta}}=\mathbf{W} \cdot{ }^\mathrm{b} \boldsymbol{\omega}
$$

​		其中${ }^{\mathrm{e}} \dot{\mathbf{p}}$为在地球固联坐标系下刚体所处的位置，${ }^{\mathrm{e}}\mathbf{v}$为为在地球固联坐标系下刚体的速度，$\dot{\boldsymbol{\Theta}}$为刚体当前欧拉角的导数，其中欧拉角的转动依次为偏航角、俯仰角、横滚角，$\mathbf{W}$为刚体当前欧拉角的导数到载体坐标系下三轴角速度的转换矩阵，${ }^{b} \boldsymbol{\omega}$为载体坐标系下三轴的角速度。

#### 2.2.1.2 基于旋转矩阵的刚体运动学模型

​		基于旋转矩阵的刚体运动学模型可由下式联立表示：
$$
{ }^{\mathrm{e}} \dot{\mathbf{p}}={ }^{\mathrm{e}} \mathbf{v}
$$

$$
\dot{\mathbf{R}}=\mathbf{R}\left[{ }^{b} \boldsymbol{\omega}\right]_{\times}
$$

​		其中${ }^{\mathrm{e}} \dot{\mathbf{p}}$为在地球固联坐标系下刚体所处的位置，${ }^{\mathrm{e}}\mathbf{v}$为为在地球固联坐标系下刚体的速度，$\dot{\mathbf{R}}$为刚体从载体坐标系到地球固联坐标系的旋转矩阵的导数，$\mathbf{R}$为刚体从载体坐标系到地球固联坐标系的旋转矩阵，$\left[{ }^{b} \boldsymbol{\omega}\right]_{\times}$为载体坐标系下三轴的角速度的反对称矩阵。

#### 2.2.1.3 基于四元数的刚体运动学模型

​		基于四元数的刚体运动学模型可由下式联立表示：
$$
{ }^\mathrm{e} \dot{\mathbf{p}}={ }^{\mathrm{e}} \mathbf{v}
$$

$$
\dot{q}_{0}=-\frac{1}{2} \mathbf{q}_{\mathrm{v}}^{\mathrm{T}} \cdot{ }^{\mathrm{b}} \boldsymbol{\omega}
$$

$$
\dot{\mathbf{q}}_{\mathrm{v}}=\frac{1}{2}\left(q_{0} \mathbf{I}_{3}+\left[\mathbf{q}_{\mathrm{v}}\right]_{\times}\right)^{\mathrm{b}} \boldsymbol{\omega}
$$

​		其中${ }^{\mathrm{e}} \dot{\mathbf{p}}$为在地球固联坐标系下刚体所处的位置，${ }^{\mathrm{e}}\mathbf{v}$为为在地球固联坐标系下刚体的速度，$\dot{q}_{0}$为四元数实部的导数，$\dot{\mathbf{q}}_{\mathrm{v}}$为四元数虚部的导数，${ }^{b} \boldsymbol{\omega}$为载体坐标系下三轴的角速度。

#### 2.2.1.4 位置动力学模型

​		由牛顿第二定律，和多旋翼受力简化的假设，即多旋翼只受沿$\mathrm{z}_\mathrm{b}$轴(载体坐标系)负方向的螺旋桨拉力和沿$\mathrm{z}_\mathrm{e}$轴(地球固联系)的重力，进行受力分析可得：
$$
{ }^\mathrm{e} \dot{\mathbf{v}}=g \mathbf{e}_{3}-\frac{f}{m}{ }^{\mathrm{e}} \mathbf{b}_{3}
$$

$$
{ }^\mathrm{e} \mathbf{v}=\mathbf{R}\cdot{ }^\mathrm{e} \mathbf{v}
$$

​		对2式求导并代入1式可得
$$
{ }^{\mathrm{b}} \dot{\mathbf{v}}=-\left[{ }^{\mathrm{b}} \boldsymbol{\omega}\right]_{\times}{ }^{\mathrm{b}} \mathbf{v}+g \mathbf{R}^{\mathrm{T}} \mathbf{e}_{3}-\frac{f}{m} \mathbf{e}_{3}
$$
​		其中${ }^\mathrm{e} \dot{\mathbf{v}}$为地球固联系下飞行器的加速度，$g$为重力加速度，$f$为螺旋桨提供的拉力，$m$为飞行器的质量，$\mathbf{R}$为飞行器从载体坐标系到地球固联系的旋转矩阵。

#### 2.2.1.5 姿态动力学模型

​		为了简化四旋翼飞行器的姿态动力学模型，假设四旋翼飞行器是刚体且几何中心与重心一致，在飞行过程中质量和转动惯量不变，则有四旋翼姿态动力学方程：
$$
\mathbf{J} \cdot{ }^{b} \dot{\boldsymbol{\omega}}=-{ }^{b} \boldsymbol{\omega} \times\left(\mathbf{J} \cdot{ }^{b} \boldsymbol{\omega}\right)+\mathbf{G}_{\mathrm{a}}+\boldsymbol{\tau}
$$
​		其中$\boldsymbol{\tau}$为单轴螺旋桨产生的力矩，$\mathbf{G}_{\mathrm{a}}$为陀螺力矩，$\mathbf{J}$为四旋翼飞行器的转动惯量。

### 2.2.2 控制效率模型

​		由于本文设计的是“X”型四旋翼飞行器，因此只考虑“X”型四旋翼飞行器的控制效率模型。由2.1.1螺旋桨模型可知，单轴螺旋桨拉力$T_{i}$为：
$$
T_{i}=c_{\mathrm{T}} \varpi_{i}^{2}
$$
​		其中$c_{\mathrm{T}}$可由下式得到：
$$
c_{\mathrm{T}}=\frac{1}{4 \pi^{2}} \rho D_{\mathrm{p}}^{4} C_{\mathrm{T}}
$$
​		单轴螺旋桨产生的反扭矩$M_{i}$为
$$
M_{i}=c_{\mathrm{M}} \varpi_{i}^{2}
$$
​		其中$c_{\mathrm{M}}$可由下式得到：
$$
c_{\mathrm{M}}=\frac{1}{4 \pi^{2}} \rho D_{\mathrm{p}}^{5} C_{\mathrm{M}}
$$
​		由上式可得四旋翼的总拉力$f$和力矩$\tau$为：
$$
f=\sum^4_{i=1}T_i=c_{\mathrm{T}}\left(\varpi_{1}^{2}+\varpi_{2}^{2}+\varpi_{3}^{2}+\varpi_{4}^{2}\right)
$$

$$
\tau_{x}=d c_{\mathrm{T}}\left(\frac{\sqrt{2}}{2} \varpi_{1}^{2}-\frac{\sqrt{2}}{2} \varpi_{2}^{2}-\frac{\sqrt{2}}{2} \varpi_{3}^{2}+\frac{\sqrt{2}}{2} \varpi_{4}^{2}\right)
$$

$$
\tau_{y}=d c_{\mathrm{T}}\left(\frac{\sqrt{2}}{2} \varpi_{1}^{2}+\frac{\sqrt{2}}{2} \varpi_{2}^{2}-\frac{\sqrt{2}}{2} \varpi_{3}^{2}-\frac{\sqrt{2}}{2} \varpi_{4}^{2}\right)
$$

$$
\tau_{z}=c_{\mathrm{M}}\left(\varpi_{1}^{2}-\varpi_{2}^{2}+\varpi_{3}^{2}-\varpi_{4}^{2}\right)
$$

​		写成矩阵形式，则有：
$$
\left[\begin{array}{l}
f \\
\tau_{x} \\
\tau_{y} \\
\tau_{z}
\end{array}\right]=\left[\begin{array}{cccc}
c_{\mathrm{T}} & c_{\mathrm{T}} & c_{\mathrm{T}} & c_{\mathrm{T}} \\
\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & \frac{\sqrt{2}}{2} d c_{\mathrm{T}} \\
\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & \frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} \\
c_{\mathrm{M}} & -c_{\mathrm{M}} & c_{\mathrm{M}} & -c_{\mathrm{M}}
\end{array}\right]\left[\begin{array}{l}
\varpi_{1}^{2} \\
\varpi_{2}^{2} \\
\varpi_{3}^{2} \\
\varpi_{4}^{2}
\end{array}\right]
$$

### 2.2.2 动力单元模型

​		由2.1四旋翼动力系统建模分析进行公式联立，可得到四旋翼控制的动力单元模型为：
$$
\varpi=\frac{1}{T_{\mathrm{m}} s+1}\left(C_{\mathrm{R}} \sigma+\varpi_{\mathrm{b}}\right)
$$
​		其中$\varpi$为四旋翼单轴电机输出的转速，$\sigma$为控制器对四旋翼单轴电机输入的油门指令，$T_{\mathrm{m}}$为四旋翼单轴电机的动态响应时间常数。

## 2.3 鱼眼相机误差模型和标定方法

​		鱼眼镜头，是广角镜头中的一种，其焦距小于16mm而且视场角接近或等于180°。在鱼眼镜头拥有着大视场角的优势的同时，其也有着因为光学原理所产生形变的缺点。因此，在近年火热的即时建图与定位(SLAM)研究中，运用最多的是基于针孔相机原理的标准镜头，鱼眼镜头运用并不广泛。

​		基于四旋翼飞行器的视觉SLAM难点有：飞行器相较于小车、手持等场景抖动更大，实时性要求更高，因此，鲁棒的相机位姿估计以及高实时性，是基于飞行器的视觉SLAM必须具备的特点。使用多个鱼眼相机进行刚性耦合，不仅能增加视场角，获取更加丰富的环境特征信息，还能通过相机系统的转换矩阵这一冗余信息恢复地图的尺度，增加位姿估计的鲁棒性以及特征点的持续追踪概率，进而达到飞行器视觉高精度SLAM的目标。

​		由于透视投影模型不适合鱼眼镜头，所以我们采用了一种更加灵活的径向对称的投影模型。

### 2.3.1 鱼眼相机模型

​		针孔相机的透视投影模型可由以下公式描述：
$$
r=f\tan\theta
$$
​		其中$\theta$是主光轴与入射光线的夹角，$r$是像面与主点的距离，$f$是镜头的焦距。鱼眼镜头则是经常被设计成符合以下的透视模型之一：
$$
r=2f\tan(\theta/2)
$$

$$
r=f\theta
$$

$$
r=2f\sin(\theta/2)
$$

$$
r=f\sin(\theta)
$$

​		上述四个模型中最常见的模型为等距投影$(2.3)$，不同的投影模型的曲线如图2.1所示，针孔相机模型与鱼眼相机模型在几何上的差异如图2.2所示。

![image-20210411155256476](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210411155256476.png)

​		然而，真实的镜头并不完全遵从该建模，为了对所有的鱼眼相机都具有普适性，投影的一般式被设计如下：
$$
r(\theta)=k_1\theta+k_2\theta^3+k_3\theta^5+k_4\theta^7+k_5\theta^9+\cdots
$$
​		通常只需要保留前五个系数即可在有限的计算下，式$(2.6)$可以对任何不同的投影曲线有着良好的估计，若$f$为入射光线与归一化的图像坐标之间的映射关系，则有：
$$
\left(\begin{matrix}
x\\
y
\end{matrix}\right)
=r(\theta)
\left(\begin{matrix}
\cos\varphi\\
\sin\varphi
\end{matrix}\right)
=f(\phi)
$$

​		考虑到真实镜头并不会理想地对称，加入轴向与径向畸变：
$$
\Delta_r(\theta,\varphi)=
(l_1\theta+l_2\theta^3+l_3\theta^5)
(i_1\cos\varphi+i_2\sin\varphi+i_3\cos2\varphi+i_4sin2\varphi)
$$

$$
\Delta_{\mathrm{t}}(\theta, \varphi)=\left(m_{1} \theta+m_{2} \theta^{3}+m_{3} \theta^{5}\right)\left(j_{1} \cos \varphi+j_{2} \sin \varphi+j_{3} \cos 2 \varphi+j_{4} \sin 2 \varphi\right)
$$

​		代入$(2.8)$可得
$$
\mathbf{x}_{\mathrm{d}}=r(\theta) \mathbf{u}_{r}(\varphi)+\Delta_{r}(\theta, \varphi) \mathbf{u}_{r}(\varphi)+\Delta_{t}(\theta, \varphi) \mathbf{u}_{\varphi}(\varphi)
$$
​		其中$\mathbf{u}_{r}(\varphi)$和$\mathbf{u}_{\varphi}$分别是轴向与径向的单位向量。将相机平面的坐标转换到像平面，则有：
$$
\left(\begin{array}{l}
u \\
v
\end{array}\right)=\left[\begin{array}{cc}
m_{u} & 0 \\
0 & m_{v}
\end{array}\right]\left(\begin{array}{l}
x_{\mathrm{d}} \\
y_{\mathrm{d}}
\end{array}\right)+\left(\begin{array}{l}
u_{0} \\
v_{0}
\end{array}\right)=\mathcal{A}\left(\mathrm{x}_{\mathrm{d}}\right)
$$
​		其中$(u_0,v_0)^T$是主点，$m_u$和$m_v$单位是像平面水平方向和垂直方向的单位像素。由$(2.11)$$(2.12)$联立可得总的鱼眼相机模型：
$$
\mathbf{m}=\mathcal{P}_{\mathrm{c}}(\Phi)
$$

​		其中$\mathbf{m}=(u,v)^T$，因此，鱼眼相机总共有$23$个参数需要估计，以$\mathbf{p_{23}}$表示。

### 2.3.2 鱼眼相机标定

​		单目鱼眼相机标定过程总共包含四步。假设相机从$N$个视角观测到$M$个特征点，对于每个视角，若有旋转矩阵$R_j$和位移向量$t_j$描述从相机相对于标定板的位置，则有：
$$
\mathbf{X}_{\mathbf{c}}=\mathbf{R}_{j} \mathbf{X}+\mathbf{t}_{j}, \quad j=1, \ldots, N
$$
​		设标定板与$XY$平面重合，则特征点的坐标可表示为$\mathbf{X^i}=(X^i,Y^i,0)$，相应的齐次坐标可表示为$\mathbf{x_p^j}=(X^i,Y^i,1)^T$，在第$j$个视角中的观测坐标为$\mathbf{m_j^i}=(u_j^i,v_j^i)^T$。标定过程的前三步只与六个相机内参有关，缩写为$\mathbf{p}_{6} \hat{=}\left(k_{1}, k_{2}, m_{u}, m_{v}, u_{0}, v_{0}\right)$，其他的参数仅与最后一步有关。

#### 2.3.2.1 内参初始化

​		鱼眼模型$r=k_1\theta+k_2\theta^3$中$k_1$和$k_2$的初始值，是由生产厂商提供的公称焦距$f$和视场角$\theta_{max}$计算所得，并可通过$r_{max}=k_1\theta_{max}+k_2\theta_{max}^3$获取相机平面的图像半径。

​		对于鱼眼镜头，真实图像只在图像帧的一个类圆区域之中，在像平面中，真实图像则在一个椭圆区域之中，有：
$$
\left(\frac{u-u_{0}}{a}\right)^{2}+\left(\frac{v-v_{0}}{b}\right)^{2}=1
$$
​		同时还有$m_u=a/r_{max}$和$m_v=b/r_{max}$，因此，可以通过上述计算$\mathbf{p_6}$中的$m_u$，$m_v$，$u_0$和$v_0$。

#### 2.3.2.2 计算逆投影和单应矩阵

​		结合内参$\mathbf{p_6}$，将观测点$\mathbf{m_j^i}$逆投影到以相机为原点的单位球面上，这些点以$\tilde{\mathbf{x}}_{j}^{i}$表示，因为观测点从标定板到单位球面的变换属于透视投影，所以存在单应矩阵$\mathbf{H_j}$有$s\tilde{\mathbf{x}}_{j}^{i}=\mathbf{H_j}\mathbf{x_p^i}$。

​		以下是对于任意视角$j$的单应矩阵$\mathbf{H_j}$的计算方法：

1. 通过计算归一化图像坐标来逆投影特征点：

$$
\left(\begin{array}{l}
x_{j}^{i} \\
y_{j}^{i}
\end{array}\right)=\left[\begin{array}{cc}
1 / m_{u} & 0 \\
0 & 1 / m_{v}
\end{array}\right]\left(\begin{array}{c}
u_{j}^{i}-u_{0} \\
v_{j}^{i}-v_{0}
\end{array}\right)
$$

然后将之转化为极坐标$\left(r_{j}^{i}, \varphi_{j}^{i}\right)=\left(x_{j}^{i}, y_{j}^{i}\right)$，最后，通过求解一元三次方程$k_{2}\left(\theta_{j}^{i}\right)^{3}+k_{1} \theta_{j}^{i}-r_{j}^{i}=0$得到值$\theta_{j}^{i}$。

2. 令$\tilde{\mathbf{x}}_{j}^{i}=\left(\sin \varphi_{j}^{i} \sin \theta_{j}^{i}, \cos \varphi_{j}^{i} \sin \theta_{j}^{i}, \cos \theta_{j}^{i}\right)$。
3. 通过线性归一化算法，由$\tilde{\mathbf{x}}_{j}^{i} \leftrightarrow \mathbf{x}_{\mathrm{p}}^{i}$之间的映射关系计算单应矩阵$\mathbf{H_j}$的初始估计值。
4. 通过最小二乘减小$\sum_{i} \sin ^{2} \alpha_{j}^{i}$来优化单应矩阵$\mathbf{H_j}$，其中$\alpha_{j}^{i}$是单位向量$\tilde{\mathbf{x}}_{j}^{i}$与$\hat{\mathbf{x}}_{j}^{i}$的夹角。

#### 2.3.2.3 外参初始化

​		相机外参的初始值是从单应矩阵分解而来的，有：
$$
s \tilde{\mathbf{x}}_{j}^{i}=\left[\begin{array}{ll}
\mathbf{R}_{j} & \mathbf{t}_{j}
\end{array}\right]\left(\begin{array}{c}
X^{i} \\
Y^{i} \\
0 \\
1
\end{array}\right)=\left[\begin{array}{lll}
\mathbf{r}_{j}^{1} & \mathbf{r}_{j}^{2} & \mathbf{t}_{j}
\end{array}\right]\left(\begin{array}{c}
X^{i} \\
Y^{i} \\
1
\end{array}\right)
$$
​		其中$\mathbf{H}_{j}=\left[\mathbf{r}_{j}^{1} \mathbf{r}_{j}^{2} \mathbf{t}_{j}\right]$，另有：
$$
\mathbf{r}_{j}^{1}=\lambda_{j} \mathbf{h}_{j}^{1}, \quad \mathbf{r}_{j}^{2}=\lambda_{j} \mathbf{h}_{j}^{2}, \quad \mathbf{r}_{j}^{3}=\mathbf{r}_{j}^{1} \times \mathbf{r}_{j}^{2}, \quad \mathbf{t}_{j}=\lambda_{j} \mathbf{h}_{j}^{3}
$$
​		其中$\lambda_{j}=\operatorname{sign}\left(H_{j}^{3,3}\right) /\left\|\mathbf{h}_{j}^{1}\right\|$，由于存在估计误差，计算得到的旋转矩阵不是正交矩阵，所以需要使用奇异值分解的方法计算最接近的正交矩阵，并令其作为$\mathbf{R}_{j}$的初始估计值。

#### 2.3.2.4 投影误差最小化

​		鱼眼模型参数$\mathbf{p_{23}}$的除$\mathbf{p_6}$之外的其他参数初始值设置为$0$，使用式$(2.11)$、$(2.12)$和$(2.14)$来计算特征点满足$\hat{\mathbf{m}}_j^i=\mathcal{P}_j(\mathbf{X}^i)$情况下相机的成像函数$\mathcal{P}_j$，通过最小化观测与建模特征点投影之间的距离之和，优化相机的参数。
$$
\sum_{j=1}^{N} \sum_{i=1}^{M} d\left(\mathbf{m}_{j}^{i}, \hat{\mathbf{m}}_{j}^{i}\right)^{2}
$$
​		优化采用的是列文伯格-马夸尔特(L-M)算法。

# 3 飞行器硬件系统的设计

​		飞行器硬件系统设计包括了飞行器传感器数据采集和飞行器硬件结构设计，下文将讲述了上述部分的具体实现。

## 3.1 飞行器传感器数据的采集

​		飞行器传感器数据的采集包括飞行器硬件电路的设计、飞行器的数据采集与同步和飞行器的数据流向，下文将对各部分进行具体描述。

### 3.1.1 飞行器硬件电路的设计

​		飞行器采用4S锂电池进行单电源供电，由于锂电池电压在飞行器飞行时变化电压范围为$12V-16.8V$，所以需要采用稳压模块方能给飞行控制器ACFLY供电，设计稳压模块如下：

![image-20210425143647691](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210425143647691.png)

​		其中使用的电路芯片为MP1584，通过该电路即可输出$5V$电压为ACFLY供电。其中，MP1584输入电压范围为$4.5V-28V$，输出电压为$0.8V-25V$，根据官方给出的电路图和公式，得到电路计算公式如下：
$$
V_{out}=V_{FB}\cdot\frac{R_3+R_5}{R_5}
$$
​		其中，$V_{FB}=0.8V$，根据已有电阻做配比，得$R_3=130k\Omega$，$R_5=24k\Omega$，

​		为了监测电池工作状态，需要设计电路测出电池输出的电压与电流，设计电流计如下：

![img](file:///D:\ChatDocument\2713168429\Image\C2C\H@7`Q{T$A2{JSC[[8DF~`WY.png)

![image-20210425144939801](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210425144939801.png)

​		其中电流计采用的芯片为INA139，通过该电路即可输出分别与电池电压和电流成线性的电压，将电压输入ACFLY的ADC接口，即可测出电池输出的电压与电流，电路计算公式如下：
$$
V_{out1}=\frac{I_sR_1R_4}{1k\Omega}
$$

$$
V_{out2}=\frac{R_{14}}{R_{9}+R_{14}}VDS
$$

​		对于飞行控制器ACFLY，除了IMU和气压计以外，其余传感器都通过串口进行连接。IMU中，陀螺仪与加速度计采用的是BMI088，磁力计采用的是AK8975，通过SPI进行通信，高度传感器中，气压计采用的是SPL06，通过IIC进行通信，连接原理图如下：

![img](file:///D:\ChatDocument\2713168429\Image\C2C\27BE23B750A2A98C7511B6F03F6A48BD.png)

​		其余传感器为开发厂商设计的独立模块，在后续模块连接部分进行讲述。

### 3.1.2 飞行器的数据采集与同步

​		飞行器的数据采集方式分别有：SPI，IIC，UART，其中，陀螺仪与加速度计采用的是BMI088，磁力计采用的是AK8975，通过SPI进行通信，气压计采用的是SPL06，通过IIC进行通信，tof高度传感器采用的是tfmini-S，通过UART进行通信，飞行控制器与计算单元使用的协议是Mavlink，通过UART进行通信。

​		对于数据同步，本文采用的时间同步算法是线性插值，使用两个时间段的已知量对两时间段之间的未知量进行线性插值。

​		由于除相机以外，其他的传感器的数据采集频率较高，所以在采样时间内数据可近似为线性变化，由于飞行控制器采用的是实时操作系统，因此可以在数据采集的时候给数据加时间戳，记录系统时间，在进行数据融合的时候，假设数据融合需要采集的数据时间为$t_k$，其前一刻某数据采集的时间戳为$t_m$，数值为$M$，其后一刻某数据采集的时间戳为$t_n$，数值为$N$，则对$t_k$时刻的数据进行线性插值得：
$$
K=\frac{N-M}{t_n-t_m}\cdot(t_k-t_m)
$$
​		对除相机之外所有数据进行线性插值后，即可认为所有数据已被时间同步。而对于相机，由于生产厂商在输出已经做出了较好的数据同步，因此只需要对视觉定位算法的输出的位姿进行线性插值即可。

### 3.1.2 飞行器的数据流向

​		飞行器的数据流向如图所示：

![新建 Microsoft Visio Drawing (2) - 副本(1)](D:\ChatDocument\2713168429\FileRecv\新建 Microsoft Visio Drawing (2) - 副本(1).png)

​		其中，用于飞行器控制的数据融合共有三路输入：

1. 视觉SLAM位姿信息、速度信息。

2. 高度传感器融合的高度信息、微分的$z$轴速度信息。

3. IMU解算的姿态信息、积分速度信息、双积分位置信息。

   其中，高度传感器包括相对测距的tof测距传感器和绝对测距的气压计。

​		对于相机信息和视觉SLAM信息的传输，都通过ROS主机进行仲裁与连接，并通过mavros进行下发，输入数据融合。

## 3.2 飞行器硬件结构的设计

​		飞行器硬件结构的设计包括飞行器布局的设计、飞行器结构的设计、飞行器载荷计算与动力选用和模块连接。下文将对各部分进行具体描述。

### 3.2.1 飞行器布局的设计

​		飞行器布局的设计包括飞行器机身的基本布局、飞行器旋翼的安装、飞行器尺寸选用、飞行器重心位置的设置。

1. 飞行器机身的基本布局：飞行器机身布局分为交叉型和环型，其中交叉型分为$+$型和$X$型，考虑飞行器重量、机动性和对前视相机的影响，所以选用$X$型机身。
2. 飞行器旋翼的安装：飞行器旋翼的安装包括旋翼布局、桨盘角度、旋翼安装。其中旋翼布局包括常规布局和共轴双桨，由于采用的为四旋翼，因此只能采用常规布局；桨盘角度包括桨盘水平和桨盘倾斜，其中桨盘水平装配更加简单，而桨盘倾斜则可以在横向运动的时候不出现倾斜，本文选择了桨盘水平安装；旋翼安装分为旋翼在机臂上方和旋翼在机臂下方，其中旋翼在机臂上方遮挡相机的视野小，且多数飞行器选择旋翼在机臂上方，旋翼在机臂下方则下洗气流完整，本文选择了旋翼在机臂上方。
3. 飞行器尺寸选用：由于飞行器工作于室内，且小型飞行器经典轴距型号为330mm和450mm，考虑到载重和安装体积，因此本文选择了450mm轴距的飞行器，相应的选择了11寸桨叶。
4. 飞行器重心位置的设置：若飞行器重心在很靠上的位置，则会使得四旋翼飞行器在一些运动模态下不稳定，因此，本文，选择飞行器重心尽量靠近中心。

### 3.2.2 飞行器结构的设计

​		飞行器结构设计的基本需求是：

1. 在电机载荷允许下，机架强度符合需求，且不会因为电机震动和使零件晃动。
2. 尽可能地减小飞行器的重量和振动性
3. 在满足上述要求的情况下，尽可能地美观耐用

​		基于上述原则，本文设计出的飞行器机架模型如图所示：

![image-20210425234232096](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210425234232096.png)

​		其中，电机座与螺旋桨为淘宝采购，其余为自行设计，螺旋桨材料为合成材料，电机座、脚架转接、管夹和螺柱为铝合金材料，中心板和机臂为碳纤维。

### 3.2.3 飞行器载荷计算与动力选用

​		由章节2.1四旋翼飞行器动力系统建模已经有对于飞行器动力计算的描述，故不再赘述，对无人自主飞行器所需要的传感器、飞行控制器和计算单元进行称重，并考虑轴距、飞行时间与飞行器总载荷，通过北航的飞行器动力计算网站www.flyeval.com进行计算，可得在研究情景下的合理的动力配置，如图为计算结果：

![image-20210426154321872](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426154321872.png)

![image-20210426154402081](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426154402081.png)

![image-20210426154428148](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426154428148.png)

![image-20210426154611805](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426154611805.png)

​		最终选用的动力配置为：

1. 电机：群汐QX3507 680kv
2. 电调：T-motor 破风 F35A
3. 螺旋桨：朗宇EOLO 1145

​		经实际装配，可得整机重量为 ，如图为整机称重：

![image-20210426161359399](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426161359399.png)

### 3.2.4 模块连接

​		对于陀螺仪、加速度计、磁力计和气压计，为了缩小体积，本文采用了板载的方式，与飞行控制器芯片通过软排线的方式进行连接，如图所示：

![image-20210426161156125](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426161156125.png)

​		为了增强减震性能，通过斜拉减振球的方式对飞行控制器进行减震，如图所示：

![image-20210426161538323](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426161538323.png)

​		除上述传感器通过板载的方式连接之外，其他传感器系生产厂商设计的独立模块，需要通过连接线进行连接。对于飞行控制器的连接，需要考虑连接的稳定性，因此本文采用了GH1.25接口进行除板载连接之外的所有模块的连接。如图所示，分别为飞行控制器与电流计的连接、与tof的连接和与计算单元的连接：

![image-20210426161911363](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426161911363.png)

![image-20210426162025921](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426162025921.png)

![image-20210426162351106](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426162351106.png)

​		对于计算单元的连接，由于使用计算单元为Nvidia的Jetson Xavier NX，厂商提供了40pin的TTL引脚和4*USB-A作为引出，双目相机T265使用的则是USB3.0接口，因此通过USB-A与双目相机T265使用转接线进行连接，通过TTL与飞行控制器通过自制转接线进行连接。如图所示，分别为计算单元与双目相机T265的连接和与飞行控制器的连接。

![image-20210426162621275](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426162621275.png)

![image-20210426162856943](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426162856943.png)

​		对于电机与电调、电调与飞行控制器的连接，采用的是传统的香蕉头和3pin信号线进行连接。如图所示，分别为电机与电调、电调与飞行控制器的连接：

![image-20210426163250897](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426163250897.png)

![image-20210426163405822](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426163405822.png)

​		对于分电板，则采用自行设计的中心板与电池、电流计、电调、计算单元通过XT60接口、焊接和圆形电源接口进行连接。如图所示，分别为底板与电池、电流计、电调、计算单元的连接：

![image-20210426163615515](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426163615515.png)

![image-20210426163914773](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426163914773.png)

![image-20210426164029616](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426164029616.png)

![image-20210426164148505](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426164148505.png)

​		如图为本文设计的飞行器整机：

![image-20210426164232675](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210426164232675.png)

# 4 飞行器软件系统的设计

​		飞行器软件系统设计包括飞行器基于双目鱼眼相机的定位、飞行器闭环控制、飞行器通信和飞行器软件系统框架构建，下文将讲述了上述部分的具体实现。

## 4.1 基于双目鱼眼相机的视觉SLAM技术

​		本文采用的视觉定位算法是ORB-SLAM3。ORB-SLAM3是由Carlos Campos与Richard Elvira于2020年论文*提出的。ORB-SLAM3由三个线程组合而成，分别是：跟踪(Tracking)、构建地图(Local Mapping)、回环检测与地图融合(Loop&Map Merging)。结构如图3.1所示：

![image-20210411173519494](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210411173519494.png)

​		ORB-SLAM3的前端由跟踪和构建地图构成，负责根据多帧连续的图像提供的信息估计相机位姿与特征点位置，给后端提供较好的初始值。后端由回环检测与地图融合构成，负责进行位置感知与回环检测，在大尺度的轨迹与地图上进行子地图拼接与全局优化。

​		下文将介绍ORB-SLAM3的关键技术：ORB特征点的提取与描述、通用相机模型、光束法平差(BA)和基于词袋模型的回环检测。

### 4.1.1 ORB特征点的提取与描述

​		ORB-SLAM3前端采用的是特征点法，特征点包括关键点和描述子，关键点描述的是特征点的位置，而描述子则描述了特征点周围像素的信息，相对于传统的SIFT算子(尺度不变特征变换)和基于SIFT改进的SURF算子，ORB在精度与鲁棒性降低的情况下，大大提升了计算的速度，ORB在FAST提取特征点的基础上，改进了FAST不具有旋转不变性的问题，满足了飞行器对于实时性要求。

​		ORB提取关键点的思路是，若像素其一定半径的邻域像素亮度差异明显，则该像素有可能是角点。其检测过程如下：

1. 选取图像中亮度为$I_p$的像素点$p$，并基于其亮度设置阈值$T$。
2. 以像素$p$为中心，对其周围半径为$R$的圆上进行搜索。
3. 设置数量$N$，若圆上有连续$N$个像素亮度在$\left[I_p-T,I_p+T\right]$之外，则该像素$p$可能是特征点。

​		ORB针对FAST不具有旋转不变性和尺度信息的缺点，做出了改进：针对FAST不具有尺度的缺点，ORB构建了图像金字塔，对每一层图像都进行角点的提取与检测，而针对不具有旋转不变性的缺点，ORB通过灰度质心法计算该算子的方向。

​		对于ORB特征点的描述采用的是BRIEF描述子，通过多种概率分布随机选取像素点$p$周围$n$个像素点对$x$和$y$，若$I_x>I_y$，则记录值$f_n(p)$为0，若$I_x<I_y$，则记录值$f_n(p)$为1，将记录值根据选取顺序由小到大排列，存储于字符串中，最后在特征点匹配时，通过计算两个字符串的汉明距离，并将其作为匹配的依据。

### 4.1.2 通用相机模型

​		相较于ORB-SLAM2，ORB-SLAM3对于相机模型有了较大的改进，在SLAM常用的针孔相机模型(pin-hole model)基础之上，ORB-SLAM3为了追求适配所有的相机，还加入了鱼眼相机模型(Kannala-Brandt)，关于该相机模型与其标定方法在章节2.3鱼眼相机误差模型和标定方法已经有完整描述，故不再赘述，下文将讲述ORB-SLAM3针对鱼眼相机模型做出的算法的调整。

1. 重定位。ORB-SLAM2针对于重定位的算法使用的是ePnP,而该算法是在使用相机为针孔相机的前提下进行计算的，并不适配于鱼眼相机模型。因此，为了让PnP算法对所有相机都适配，ORB-SLAM3将PnP算法与相机模型解耦，采用了MLPnP(Maximum Likelihood Perspective-n-Point)算法，相机模型则需要将像素通过投影函数转化成投影光线即可输入MLPnP算法中。

2. 去极线校正。ORB-SLAM2默认双目相机的图像是做过极线校正的，极线校正通过计算双目相机之间的三维变换，将两张图像通过转换矩阵投影到同一个平面上，并进行行对齐，极线则被转换至无限远，这样的好处是进行特征点匹配的时候只需对同一行进行搜索即可。但是，针对于两个不同的相机，或者鱼眼相机，对其做极线校正则会伴随着大量的图像剪裁，这样则丧失了鱼眼相机视场角广的优点。因此，ORB-SLAM3进行了以下改进：

   两个不同的相机或鱼眼相机满足以下假设：

   1. 双目相机整体可以拆分成两个独立的单目相机。
   2. 两个独立的单目相机之间存在相对的常值三维转换。
   3. 两个独立的单目相机存在共视区域。

   对于两个相机的共视区域，ORB-SLAM3会通过双目相机模型对特征点以视差计算深度，恢复出特征点的真实尺度，而对于两个相机的非共视区域，ORB-SLAM3则会从中提取许多单目相机的相关信息，对于这些特征点的初始化则会通过单目相机模型的三角化测量进行估计。

### 4.1.3 光束法平差(BA)

​		根据本文2.3的相机模型可以将三维的点坐标转化成像素坐标，若对坐标$\boldsymbol{p}=[P_x,P_y,P_z]^T$，进行$z$方向的归一化，且有映射关系$h$能描述归一化的坐标$p'$到像素点坐标$\boldsymbol{z}\triangleq[u,v]$之间的变换关系，若此时的相机位姿为$\boldsymbol{x}$，则有：
$$
\boldsymbol{z}=h(\boldsymbol{x},\boldsymbol{y})
$$
​		其中$\boldsymbol{x}$为相机在观测到路标时的位姿，$\boldsymbol{y}$为路标，也就是当前的三维点坐标$\boldsymbol{p}$，$\boldsymbol{z}$为观测到的三维点的像素点坐标，将相机位姿使用李代数$\boldsymbol{\xi}$来表示，则根据上式可以写出此次观测的误差：
$$
\boldsymbol{e}=\boldsymbol{z}-h(\boldsymbol{\xi},\boldsymbol{p})
$$
​		若考虑对象为连续时刻通过多个相机位姿对多个三维点进行观测，设$\boldsymbol{z}_{ij}$为在相机位姿为$\boldsymbol{\xi_i}$下对路标$\boldsymbol{p}_j$的观测，则其代价函数为：
$$
\frac{1}{2} \sum_{i=1}^{m} \sum_{j=1}^{n}\left\|\boldsymbol{e}_{i j}\right\|^{2}=\frac{1}{2} \sum_{i=1}^{m} \sum_{j=1}^{n}\left\|\boldsymbol{z}_{i j}-h\left(\boldsymbol{\xi}_{i}, \boldsymbol{p}_{j}\right)\right\|^{2}
$$
​		对于代价函数进行最小二乘求解，则可以对相机位姿$\boldsymbol{\xi}$与路标$\boldsymbol{p}$进行调整，即为所述的光束法平差(BA)，以下将讲解BA的过程：

​		定义所有待优化变量$\boldsymbol{x}$、相机位姿变量$\boldsymbol{x_c}$和三维点位置的变量$\boldsymbol{x_p}$为：
$$
\boldsymbol{x}=[\boldsymbol{\xi}_1,\cdots,\boldsymbol{\xi}_m,\boldsymbol{p}_1,\cdots,\boldsymbol{p}_n]^T
$$

$$
\boldsymbol{x}_c=[\boldsymbol{\xi}_1,\boldsymbol{\xi}_2,\cdots,\boldsymbol{\xi}_m]^T
$$

$$
\boldsymbol{x}_p=[\boldsymbol{p}_1,\boldsymbol{p}_2,\cdots,\boldsymbol{p}_n]^T
$$

​		则非线性优化的目标函数有
$$
\begin{array}{l}
\frac{1}{2}\|f(\boldsymbol{x}+\Delta \boldsymbol{x})\|^{2} \approx \frac{1}{2} \sum_{i=1}^{m} \sum_{j=1}^{n}\left\|\boldsymbol{e}_{i j}+\boldsymbol{F}_{i j} \Delta \boldsymbol{\xi}_{i}+\boldsymbol{E}_{i j} \Delta \boldsymbol{p}_{j}\right\|^{2} \\
=\frac{1}{2} \sum_{i=1}^{m} \sum_{j=1}^{n}\left\|\boldsymbol{e}+\boldsymbol{F} \Delta \boldsymbol{x}_{c}+\boldsymbol{E} \Delta \boldsymbol{x}_{p}\right\|^{2}
\end{array}
$$
​		其中，第一个约等式为一阶项的泰勒展开，$\boldsymbol{F}_{i j}$为单一代价函数对单一相机位姿的偏导，$\boldsymbol{E}_{i j}$为单一代价函数对单一三维点位置的偏导，$\boldsymbol{F}$为整体目标函数对整体相机位姿的偏导，$\boldsymbol{E}$为整体目标函数对整体三维点位置的偏导。最后得出增量线性方程：
$$
\boldsymbol{H}\Delta\boldsymbol{x}=\boldsymbol{g}
$$
​		其中矩阵$\boldsymbol{H}$和$\boldsymbol{g}$由使用的非线性优化算法决定，若使用的高斯牛顿(G-N)的非线性优化算法，则：
$$
\boldsymbol{H}=\boldsymbol{J}(x)^T\boldsymbol{J}(x)
$$

$$
\boldsymbol{g}=-\boldsymbol{J}(x)^T f(x)
$$

​		由于存在特征点误匹配的问题，使用非线性优化算法总是会对误差项更加敏感，为了使整个优化结果鲁棒，所以引入鲁棒核函数，代替仅以二范数的度量，以Huber核为例：
$$
\boldsymbol{H}(e)=\left\{\begin{array}{ll}
\frac{1}{2} \boldsymbol{e}^{2} & \text { if }|\boldsymbol{e}| \leq \boldsymbol{\delta} \\
\boldsymbol{\delta}\left(|\boldsymbol{e}|-\frac{1}{2} \boldsymbol{\delta}\right) & \text { otherwise }
\end{array}\right.
$$

### 4.1.4 基于词袋模型的回环检测

​		ORB-SLAM3使用了DBoW2的词袋模型库作为回环检测的基础。ORB-SLAM3在局部建图的时候进行关键帧的管理，并保存在关键帧的序列中，在需要进行回环检测的时候，则将保存的关键帧序列中的每一帧关键帧的特征点转化为DBoW2的数据库中的单词，计算相似度，以下是基于词袋模型的回环检测的具体流程。

#### 4.1.4.1 回环候选检测

​		首先，算法会计算关键帧$K_i$和其小图的友邻$(\theta_{min}=30)$的词袋向量的相似度，并保留最低值$s_{min}$，然后，算法会查询位置感知数据库并丢弃所有计算值低于$s_{min}$的关键帧。为了鲁棒性，算法只会在检测到三个一致的回环候选才会接收该回环候选，如果有多个地方的场景与$K_i$相似，则会有多个循环候选。

#### 4.1.4.2 计算相似度

​		算法会计算地图点在当前帧映射的ORB算子与回环候选关键帧的相似度，可以对每个候选使用随机采样一致性(RANSAC)迭代以计算关键帧与候选的相似度，一旦相似度$S_{il}$超过搜索阈值，算法则会依据该候选帧进行更广范围的搜索，以搜寻足够多的内联，相似度$S_{il}$超过成立阈值之后，算法将认为该回环$K_l$成立，对全局关键帧位姿与地图点进行优化。

#### 4.1.4.3 回环融合

​		首先，回环融合会将重复的地图点进行剔除，并将回环的约束作为优化问题的一条边嵌入小图中，将当前关键帧，也就是触发回环的关键帧，通过相似变换将当前的位姿进行校正，然后再对当前关键帧的邻域进行校正，直至回环首尾对齐，将当前关键帧观测到的地图点进行融合，并且为所有能观测到融合地图点的关键帧进行优化问题边的更新，并将回环这一新的约束作为一条边嵌入这些关键帧的小图中。

## 4.2 飞行器闭环控制

​		本章将对四旋翼底层飞行控制框架进行整体的描述，并对其组成部分进行具体分析。

### 4.2.1 四旋翼底层飞行控制框架

​		四旋翼底层飞行控制框架如图所示：

![image-20210423200049565](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210423200049565.png)

​		四旋翼底层飞行控制框架由四部分组成：位置控制、姿态控制、控制分配和电机控制。其中将对飞行器期望的轨迹$\mathbf{p}_d$输入位置控制器中，可以输出对飞行器期望的俯仰角$\theta_d$，滚转角$\phi_d$和总拉力$f_d$；对飞行器期望的俯仰角$\theta_d$，滚转角$\phi_d$和偏航角$\psi$输入姿态控制器中，可以输出对飞行器期望的力矩$\tau_d$；将对飞行器期望的总拉力$f_d$和力矩$\tau_d$输入控制分配器中，可以输出对飞行器期望的所有螺旋桨转速$\varpi_{d,k}$，其中$k=1,2,3,4$；将对飞行器期望的螺旋桨转速$\varpi_{d,k}$输入电机控制器中，可以输出对飞行器期望的所有电机油门指令$\sigma_{d,k}$,其中$k=1,2,3,4$。

​		四旋翼飞行器全自助控制闭环框架如图所示：

![image-20210423201347682](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210423201347682.png)

​		可以看出，该闭环控制系统是一个欠驱动系统，控制器需要通过四路输入来控制六路输出，其中四路输入为总拉力$f$和三轴的力矩$\tau$，六路输出为三轴位置$\mathbf{p}$三轴姿态$\mathbf{\Theta}$。因此，对于四旋翼飞行器全自助控制闭环系统，通常采用内外环的控制方法。其中飞行器内环控制的是四旋翼飞行器的三轴姿态$\mathbf{\Theta}$，飞行器外环控制的是四旋翼飞行器的三轴位置$\mathbf{p}$。这样即可实现四旋翼飞行器的全自主飞行。

### 4.2.2 四旋翼飞行器的位置控制

​		若位置控制为产生期望欧拉角的控制，则由章节2.2四旋翼控制建模和小角度模型等效可得水平位置通道的模型为：
$$
\dot{\mathbf{p}}_h=\mathbf{v}_h
$$

$$
\dot{\mathbf{v}}_h=-g\mathbf{A}_{\psi}\mathbf{\Theta}_h
$$

​		若能达到期望速度，即可达到期望位置，基于这一理论且为了使$\lim _{t \rightarrow \infty}\left\|\mathbf{e}_{\mathbf{p}_{\mathrm{h}}}(t)\right\|=0$则有：
$$
\mathbf{v}_{hd}=\mathbf{K}_{\mathbf{p}_h}(\mathbf{p}_{hd}-\mathbf{p}_h)
$$

$$
\mathbf{e}_{\mathbf{v}_{\mathrm{h}}}\triangleq\mathbf{v}_{\mathrm{h}}-\mathbf{v}_{\mathrm{hd}}
$$

​		为了使$\lim _{t \rightarrow \infty}\left\|\mathbf{e}_{\mathbf{v}_{\mathrm{h}}}(t)\right\|=0$且根据PID理论则有：
$$
\boldsymbol{\Theta}_{\mathrm{hd}}=g^{-1} \mathbf{A}_{\psi}^{-1}\left(\mathbf{K}_{\mathbf{v}_{\mathrm{h}} \mathrm{P}} \mathbf{e}_{\mathbf{v}_{\mathrm{h}}}+\mathbf{K}_{\mathrm{v}_{\mathrm{h}} \mathrm{i}} \int \mathbf{e}_{\mathbf{v}_{\mathrm{h}}}+\mathbf{K}_{\mathrm{v}_{\mathrm{h}} \mathrm{d}} \dot{\mathbf{e}}_{\mathrm{v}_{\mathrm{h}}}\right)
$$
​		其中$\mathbf{K}_{\mathbf{v}_{\mathrm{h}} \mathrm{P}}$为PID中的比例系数，$\mathbf{K}_{\mathbf{v}_{\mathrm{h}} \mathrm{i}}$为PID中的积分系数，$\mathbf{K}_{\mathbf{v}_{\mathrm{h}} \mathrm{d}}$为PID中的微分系数。

​		高度通道模型同理，且需要考虑重力，有：
$$
\dot{p}_z=v_z
$$

$$
\dot{v}_z=g-\frac{f}{m}
$$

​		若能达到期望角度，即可达到期望速度，基于这一理论且为了使$\lim _{t \rightarrow \infty}\left\|{e}_{p_z}(t)\right\|=0$则有：
$$
{v}_{zd}={k}_{{p}_z}({p}_z-{p}_{zd})
$$

$$
{e}_{{v}_{{z}}}={v}_{{z}}-{v}_{{zd}}
$$

​		为了使$\lim _{t \rightarrow \infty}\left\|\mathbf{e}_{\mathbf{v}_{z}}(t)\right\|=0$且根据PID理论则有：
$$
f_{\mathrm{d}}=m\left(g+k_{v_{v} \mathrm{p}} e_{v_{z}}+k_{v_zi} \int e_{v_{z}}+k_{v_{z}d} \dot{e}_{v_{z}}\right)
$$
​		为了防止误差过大导致小角度模型失效，使控制器无意义，因此需要对控制加饱和，对输出量进行限幅，则有：
$$
\mathbf{e}_{\mathbf{v}_{\mathrm{h}}}=\operatorname{sat}_\mathrm{gd}(\mathbf{v}_{\mathrm{h}}-\mathbf{v}_{\mathrm{hd}},a_1)
$$

$$
\boldsymbol{\Theta}_{\mathrm{hd}}=\operatorname{sat}_\mathrm{gd}\left(g^{-1} \mathbf{A}_{\psi}^{-1}\left(\mathbf{K}_{\mathbf{v}_{\mathrm{h}} \mathrm{P}} \mathbf{e}_{\mathbf{v}_{\mathrm{h}}}+\mathbf{K}_{\mathrm{v}_{\mathrm{h}} \mathrm{i}} \int \mathbf{e}_{\mathbf{v}_{\mathrm{h}}}+\mathbf{K}_{\mathrm{v}_{\mathrm{h}} \mathrm{d}} \dot{\mathbf{e}}_{\mathrm{v}_{\mathrm{h}}}\right),a_2\right)
$$

$$
{e}_{{v}_{{z}}}=\operatorname{sat}_\mathrm{gd}({v}_{{z}}-{v}_{{zd}},a_3)
$$

$$
f_{\mathrm{d}}=\operatorname{sat}_\mathrm{gd}\left(m\left(g+k_{v_{v} \mathrm{p}} e_{v_{z}}+k_{v_zi} \int e_{v_{z}}+k_{v_{z}d} \dot{e}_{v_{z}}\right),a_4\right)
$$

​		其中$sat_{gd}(\mathbf{x},a)$为保方向的饱和函数，其定义如下：
$$
\operatorname{sat}_{\mathrm{gd}}(\mathbf{x}, a) \triangleq\left\{\begin{array}{c}
\mathbf{x},\|\mathbf{x}\|_{\infty} \leq a \\
a \cdot \frac{\mathbf{x}}{\|\mathbf{x}\|_{\infty}}
,\|\mathbf{x}\|_{\infty}>a
\end{array}\right.
$$

### 4.2.3 四旋翼飞行器的姿态控制

​		四旋翼飞行器的姿态控制的目的是：有参考四旋翼姿态角$\boldsymbol{\Theta}_\mathrm{d}=\left[\boldsymbol{\Theta}_{\mathrm{hd}}^T,\psi_{\mathrm{d}}\right]^T$，设计姿态控制器$\tau_{\mathrm{d}}$使得$\lim _{t \rightarrow \infty}\left\|\mathbf{e}_{\boldsymbol{\Theta}}(t)\right\|=0$，其中$\mathbf{e}_{\boldsymbol{\Theta}}=\boldsymbol{\Theta}-\boldsymbol{\Theta}_{\mathrm{d}}$。其中俯仰角，横滚角由位置控制器给定，偏航角由任务规划给定。针对
$$
\dot{\boldsymbol{\Theta}}=\boldsymbol{\omega}
$$
设计角速度的期望为：
$$
\boldsymbol{\omega}_{\mathrm{d}}=-\mathbf{K}_{\boldsymbol{\Theta}}\mathbf{e}_{\boldsymbol{\Theta}}
$$
​		上述两式构成了角度控制环，在$\dot{\boldsymbol{\Theta}}=0_{3\times1}$的基础上，令$\lim _{t \rightarrow \infty}\left\|\mathbf{e}_{\boldsymbol{\omega}}(t)\right\|=0$同时满足$\lim _{t \rightarrow \infty}\left\|\mathbf{e}_{\boldsymbol{\Theta}}(t)\right\|=0$，其中$\mathbf{e}_{\boldsymbol{\omega}}=\boldsymbol{\omega}-\boldsymbol{\omega}_{\mathrm{d}}$，于是针对
$$
\mathbf{J}\dot{\boldsymbol{\omega}}=\boldsymbol{\tau}
$$
设计转矩的期望为：
$$
\boldsymbol{\tau}_{\mathrm{d}}=\mathbf{K}_{\mathrm{\omega p}} e_{\mathrm{\omega}}+\mathbf{K}_{\mathrm{\omega i}} \int e_{\mathrm{\omega}}+\mathbf{K}_{\mathrm{\omega d}} \dot{e}_{\mathrm{\omega}}
$$
​		上述两式构成了角速度控制环。

### 4.2.4 四旋翼飞行器的控制分配

​		将对四旋翼飞行器期望的力矩输入控制分配器，即可输出得到对四旋翼飞行器螺旋桨的转速，控制分配器的作用是将上层控制与底层控制有效分离，并通过合理分配，防止饱和控制，提高四旋翼飞行器对故障和损伤的鲁棒性。由章节2.2.2控制效率模型可知，“X”型四旋翼飞行器的控制效率模型为：
$$
\left[\begin{array}{l}
f \\
\tau_{x} \\
\tau_{y} \\
\tau_{z}
\end{array}\right]=\left[\begin{array}{cccc}
c_{\mathrm{T}} & c_{\mathrm{T}} & c_{\mathrm{T}} & c_{\mathrm{T}} \\
\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & \frac{\sqrt{2}}{2} d c_{\mathrm{T}} \\
\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & \frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} & -\frac{\sqrt{2}}{2} d c_{\mathrm{T}} \\
c_{\mathrm{M}} & -c_{\mathrm{M}} & c_{\mathrm{M}} & -c_{\mathrm{M}}
\end{array}\right]\left[\begin{array}{l}
\varpi_{1}^{2} \\
\varpi_{2}^{2} \\
\varpi_{3}^{2} \\
\varpi_{4}^{2}
\end{array}\right]
$$
​		其中$\mathbf{M}_4$为从四旋翼飞行器螺旋桨的转速到四旋翼飞行器总拉力和三轴力矩的映射关系，因此，可以直接求逆得控制分配矩阵为$\mathbf{P}_4=\mathbf{M}_4^{-1}$，由该矩阵即可将对四旋翼飞行器的期望总拉力和期望三轴力矩转换成四旋翼飞行器螺旋桨的期望转速。

### 4.2.5 四旋翼飞行器的电机控制

​		对于每个电机的油门指令$\sigma_{\mathrm{d,k}}$，其中$\mathrm{k}=1,2,3,4$，要使得$\lim _{t \rightarrow \infty}\left|\mathbf{\varpi}_{\mathrm{k}}-\mathbf{\varpi}_{\mathrm{d,k}}\right|=0$，通常采用的是开环控制的方式，控制分配器可以输出四旋翼飞行器螺旋桨的期望转速$\mathbf{\varpi}_{\mathrm{d,k}}$，其与四旋翼飞行器的油门指令成正比，所以，控制器的表达式如下：
$$
\sigma_{\mathrm{d,k}}=a\mathbf{\varpi}_{\mathrm{d,k}}+b
$$
​		并通过四旋翼飞行器位置控制器和姿态控制器的PID参数补偿参数$a$和参数$b$即可。

## 4.3 飞行器通信

​		本文采用的通信协议是Mavlink，他是一种非常轻量级的信息传输协议, 用于地面站与无人机之间 (以及机载无人机组件之间) 进行通信。Mavlink 遵循的模式是现代混合发布-订阅和点对点设计模式：其中数据流是通过话题进行发送与发布的，而配置子协议则是基于重传机制的点对点模式实现的。下文将讲述Mavlink的特性和Mavlink的帧格式。

### 4.3.1 Mavlink的特性

​		Mavlink作为轻量级的信息传输协议有以下特性：

1. 高效性。本文采用的为Mavlink 2协议，其中Mavlink 2最少可有14个字节的开销，相比于Mavlink 1，虽然开销变大，但是它是一个更安全且可扩展的协议。作为轻量级的信息传输协议，因为单帧信息中已经包含了所有信息，所以Mavlink非常适合通信带宽非常有限的应用程序。
2. 可靠性。Mavlink自从被开发依赖一直被用于多种自动化载具和地面站、自动化载具与其他组件之间的通信，比如著名的开源飞行器团队PX4，使用的就是该通信协议，因为Mavlink拥有检测数据包丢失、损坏和数据包身份验证的特性，所以它在高延迟、噪声大等环境下依然有非常好的表现。
3. 跨平台。Mavlink提供了多种不同的编程语言版本的协议实现，因此Mavlink可以在多种不同的平台上进行快速移植与实现，本文作者即通过Mavlink实现了从ARM架构RTOS环境，Linux环境与x86架构的Linux环境下通过Mavlink进行通信，实现了跨平台飞行器组件之间、飞行器与地面站之间的通信。
4. 在单个Mavlink网络中可以同时容纳最多255个组件。
5. 支持板载组件与非板载组件之间的通信，比如飞行器和地面站之间的通信，飞行控制器和板载计算单元之间的通信。

### 4.3.2 Mavlink的帧格式

​		Mavlink帧格式如图所示：

![image-20210424133541404](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210424133541404.png)

​		各组成部分具体说明如表所示：

| 字节序号      | 名称                    | 说明                                                    |
| ------------- | ----------------------- | ------------------------------------------------------- |
| 0             | 帧开始标志位(STX)       | Mavlink协议指定的帧开始标志位                           |
| 1             | 载荷长度(LEN)           | 描述了后面的载荷(PAYLOAD)的字节长度                     |
| 2             | 不兼容标志位(INC FLAGS) | 用于形容该信息对于的Mavlink版本的兼容性                 |
| 3             | 兼容标志位(CMP FLAGS)   | 用于形容该信息对于的Mavlink版本的兼容性                 |
| 4             | 帧序列号(SEQ)           | 组件发送连续数据帧的序列号，可用于检测数据包的丢失      |
| 5             | 系统ID(SYS ID)          | 发送该帧的系统ID，通常用于辨识通信网络中不同的系统      |
| 6             | 组件ID(COMP ID)         | 发送该帧的组件ID，通常用于辨识同一个系统下不同的组件    |
| 7~9           | 信息ID(MSG ID)          | 载荷中Mavlink的信息类型，用于进行后续载荷的解码工作     |
| 10~(n+10)     | 载荷(PAYLOAD)           | Mavlink信息数据，依据信息ID进行解码                     |
| (n+10)~(n+11) | 校验位(CHECKSUM)        | Mavlink信息的校验位，使用的是循环冗余校验CRC-16/MCRF4XX |
| (n+12)~(n+25) | 签名(SIGNATURE)         | 该帧的签名，用于确保通过Mavlink的通信连接防篡改的       |

## 4.4 飞行器软件系统框架

​		飞行器软件系统框架如下图所示：

![新建 Microsoft Visio Drawing (2)](D:\ChatDocument\2713168429\FileRecv\新建 Microsoft Visio Drawing (2).png)

​		其中，在Mavlink通信网络中的组件为视觉SLAM组件和飞行控制器组件，其中视觉SLAM组件采用的是Nvidia的Jetson Xavier NX和远端电脑，飞行控制器组件采用的是ACFLY。下文将对各组件的具体功能进行描述。

### 4.4.1 视觉SLAM组件

​		视觉SLAM组件采用的是Nvidia的Jetson Xavier NX和远端电脑，且通过ROS(机器人操作系统)进行TCP/IP通信与数据传输，其中Jetson Xavier NX为板载，远端电脑为非板载。组件框架如图所示：

![image-20210424175807366](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210424175807366.png)

可以看出，总共有三个进程在同时进行：

1. ROS主机通过对相机配置文件的读取，发送相机配置参数给T265，并通过realsense驱动采集T265图像，经ROS主机仲裁后与ORB-SLAM3建立连接，通过TCP/IP的方式进行压缩图像的传输。
2. ORB-SLAM3在读取词典之后开启跟踪、局部建图、回环检测和地图融合三个线程，并等待图像输入，在与T265图像采集建立连接之后，进行视觉SLAM，回传实时的地图信息、飞行器位姿信息与速度信息。
3. mavros即mavlink在ROS端的实现，经ROS主机仲裁后与ORB-SLAM3建立连接，订阅ORB-SLAM3发布的飞行器位姿与速度信息，并将该信息打包成Mavlink格式，通过串口向ACFLY发送该信息，同时，从串口读取Mavlink连接状态回传给ROS主机。

### 4.4.2 飞行控制器组件

​		飞行控制器组件采用的是ACFLY，为一款国产开源飞行自驾仪，组件框架如图所示：

![image-20210424175841558](C:\Users\LiuZW\AppData\Roaming\Typora\typora-user-images\image-20210424175841558.png)

可以看出，总共有两个进程正在同时进行：

1. 数据融合从TOF相对测高与气压计绝对测高的融合信息中，获取飞行器基于地球固联系的$z$轴方向的高度信息与速度信息，从陀螺仪、加速度计和磁力计的姿态解算中，获取飞行器的姿态信息、积分速度信息、双积分位置信息，从Mavlink通信中，获取视觉SLAM的位姿信息和速度信息，通过对所有获取到的信息的加权，进行互补滤波融合。
2. 飞行器闭环控制基于从数据融合中获取的融合位置、融合速度和融合姿态对飞行器进行闭环控制，具体控制流程在章节4.2飞行器闭环控制已经有详细的描述，故不再赘述。

# 5 测试与分析

# 6 总结与展望

# 7 参考文献

# 8 致谢

